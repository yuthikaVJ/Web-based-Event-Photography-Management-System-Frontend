<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photographer Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }
    .dashboard { display: flex; min-height: 100vh; }
    .sidebar {
      width: 250px; background: #fff; padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { margin-bottom: 10px; }
    .sidebar a {
      text-decoration: none; color: #2d3436;
      display: block; padding: 10px; border-radius: 5px;
      transition: background 0.3s;
    }
    .sidebar a:hover, .sidebar a.active { background: rgba(102, 126, 234, 0.1); }
    .main-content { flex: 1; padding: 30px; background: rgba(255,255,255,0.95); }
    h1 { color: #2d3436; margin-bottom: 20px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background: white; border-radius: 10px; overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    tr:hover { background: #f8f9fa; }
    .content-section { display: none; }
    .content-section.active { display: block; }
    iframe { border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    #userName { font-weight: bold; color: #2d3436; margin-bottom: 15px; }
    .btn-logout { display: block; padding: 10px; text-align: center; color: #e74c3c; text-decoration: none; border-radius: 5px; background: #fff; margin-top: 20px; }
    .btn-logout:hover { background: #f1c40f; color: #fff; }
    .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
    .btn-update { background: #3498db; color: white; }
    .btn-delete { background: #e74c3c; color: white; }
    .btn-download { background: #2ecc71; color: white; text-decoration: none; }
    .btn-update:hover { background: #2980b9; }
    .btn-delete:hover { background: #c0392b; }
    .btn-download:hover { background: #27ae60; }
  </style>
</head>
<body>

<div class="dashboard">
  <div class="sidebar">
    <div>
      <h2>Photographer Portal</h2>
      <p id="userName">Welcome, Guest</p>
      <ul>
        <li><a href="#" class="nav-link active" data-target="eventSection">üì£ My Events</a></li>
        <li><a href="#" class="nav-link" data-target="calendarSection">üìÖ Calendar</a></li>
        <li><a href="#" class="nav-link" data-target="uploadSection">üìÇ Gallery Uploads</a></li>
      </ul>
    </div>
    <a href="index.html" class="btn-logout" onclick="logout()">Logout</a>
  </div>

  <div class="main-content">
    <!-- Event Section -->
    <div id="eventSection" class="content-section active">
      <h1>Assigned Events</h1>
      <table id="eventsTable">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Customer Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Event Type</th>
            <th>Date</th>
            <th>Time</th>
            <th>Location</th>
            <th>Photographer</th>
            <th>Package Type</th>
          </tr>
        </thead>
        <tbody id="eventsTableBody"></tbody>
      </table>
    </div>

    <!-- Calendar Section -->
    <div id="calendarSection" class="content-section">
      <h1>Calendar</h1>
      <iframe 
        src="https://calendar.google.com/calendar/embed?src=yuthikavj%40gmail.com&ctz=Asia%2FColombo" 
        style="border:0; width:100%; height:600px;" 
        frameborder="0" 
        scrolling="no">
      </iframe>
    </div>

    <!-- Upload Section -->
    <div id="uploadSection" class="content-section">
      <h1>Upload Gallery (ZIP)</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <label>Customer Email</label>
        <input type="email" id="customerEmail" name="customerEmail" required>

        <label>Event ID (optional)</label>
        <input type="number" id="eventId" name="eventId">

        <label>Select ZIP File</label>
        <input type="file" id="zipFile" name="file" accept=".zip" required>

        <button type="submit" class="btn btn-primary">Upload</button>
      </form>

      <div id="uploadStatus" style="margin-top: 15px; font-weight: bold;"></div>

      <h2 style="margin-top:30px;">üìÇ Uploaded Files</h2>
      <table id="fileTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>File Name</th>
            <th>Customer Email</th>
            <th>Event ID</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const EVENT_API_URL = "http://l16.16.146.15:9000/api/bookings";
const ZIP_API_URL = "http://16.16.146.15:9000/zip";

// ========== UPLOAD FORM ==========
document.getElementById("uploadForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append("file", document.getElementById("zipFile").files[0]);
  formData.append("customerEmail", document.getElementById("customerEmail").value);
  formData.append("eventId", document.getElementById("eventId").value);

  try {
    const res = await fetch(`${ZIP_API_URL}/upload`, {
      method: "POST",
      body: formData
    });

    if (res.ok) {
      const result = await res.json();
      document.getElementById("uploadStatus").textContent =
        "‚úÖ Upload successful: " + result.fileName;
      loadUploadedFiles();
    } else {
      document.getElementById("uploadStatus").textContent = "‚ùå Upload failed.";
    }
  } catch (err) {
    console.error(err);
    document.getElementById("uploadStatus").textContent = "‚ö†Ô∏è Error uploading file.";
  }
});

// ========== FILE LIST ==========
async function loadUploadedFiles() {
  try {
    const res = await fetch(`${ZIP_API_URL}/all`);
    if (!res.ok) throw new Error("Failed to fetch files");
    const files = await res.json();

    const tbody = document.getElementById("fileTableBody");
    tbody.innerHTML = "";

    if (files.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5'>No files uploaded.</td></tr>";
    } else {
      files.forEach(file => {
        tbody.innerHTML += `
          <tr>
            <td>${file.id}</td>
            <td>${file.fileName}</td>
            <td>${file.customerEmail}</td>
            <td>${file.eventId || "-"}</td>
            <td>
              <a class="btn btn-download" href="${ZIP_API_URL}/download/${file.id}" target="_blank">Download</a>
              <button class="btn btn-update" onclick="updateFile(${file.id})">Update</button>
              <button class="btn btn-delete" onclick="deleteFile(${file.id})">Delete</button>
            </td>
          </tr>`;
      });
    }
  } catch (err) {
    console.error(err);
    document.getElementById("fileTableBody").innerHTML =
      "<tr><td colspan='5'>‚ö†Ô∏è Error loading files.</td></tr>";
  }
}

// ========== DELETE FILE ==========
async function deleteFile(id) {
  if (!confirm("Are you sure you want to delete this file?")) return;
  try {
    const res = await fetch(`${ZIP_API_URL}/delete/${id}`, { method: "DELETE" });
    if (res.ok) {
      alert("‚úÖ File deleted successfully!");
      loadUploadedFiles();
    } else {
      alert("‚ùå Failed to delete file.");
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Error deleting file.");
  }
}

// ========== UPDATE FILE ==========
async function updateFile(id) {
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = ".zip";
  fileInput.onchange = async () => {
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
      const res = await fetch(`${ZIP_API_URL}/update/${id}`, {
        method: "PUT",
        body: formData
      });
      if (res.ok) {
        alert("‚úÖ File updated successfully!");
        loadUploadedFiles();
      } else {
        alert("‚ùå Update failed.");
      }
    } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è Error updating file.");
    }
  };
  fileInput.click();
}

// ========== EVENTS ==========
async function loadPhotographerEvents() {
  try {
    const res = await fetch(EVENT_API_URL);
    if (!res.ok) throw new Error("Failed to fetch events");
    const events = await res.json();
    const tbody = document.getElementById("eventsTableBody");
    tbody.innerHTML = "";

    if (!user || !user.email) {
      tbody.innerHTML = "<tr><td colspan='10'>No logged-in photographer found. Please login.</td></tr>";
      return;
    }

    const userEvents = events.filter(ev => ev.photographer && ev.photographer === user.firstName);

    if (userEvents.length === 0) {
      tbody.innerHTML = "<tr><td colspan='10'>You have no assigned events.</td></tr>";
    } else {
      userEvents.forEach(ev => {
        tbody.innerHTML += `<tr>
          <td>${ev.id}</td>
          <td>${ev.name}</td>
          <td>${ev.email}</td>
          <td>${ev.phone}</td>
          <td>${ev.eventType}</td>
          <td>${ev.date}</td>
          <td>${ev.time}</td>
          <td>${ev.location}</td>
          <td>${ev.photographer}</td>
          <td>${ev.packageType}</td>
        </tr>`;
      });
    }
  } catch (e) {
    console.error("Error loading events:", e);
    document.getElementById("eventsTableBody").innerHTML = "<tr><td colspan='10'>Failed to load events.</td></tr>";
  }
}

// ========== LOGIN ==========
const user = JSON.parse(localStorage.getItem("loggedInUser"));
const role = localStorage.getItem("userRole");
if (!user || role !== "photographer") {
  alert("You must be logged in as a photographer to access this page.");
  window.location.href = "Main.html";
}
function showLoggedInUser() {
  const userNameElement = document.getElementById("userName");
  if(user && user.firstName && user.lastName) {
    userNameElement.textContent = "Welcome, " + user.firstName + " " + user.lastName;
  } else {
    userNameElement.textContent = "Welcome, Guest";
  }
}
function logout() {
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("userRole");
  window.location.href = "Main.html";
}

// ========== NAVIGATION ==========
function setupNavigation() {
  const navLinks = document.querySelectorAll('.nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      navLinks.forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.getAttribute('data-target')).classList.add('active');
    });
  });
}

// ========== INIT ==========
document.addEventListener("DOMContentLoaded", function() {
  setupNavigation();
  showLoggedInUser();
  loadPhotographerEvents();
  loadUploadedFiles();
});
</script>

</body>
</html>
